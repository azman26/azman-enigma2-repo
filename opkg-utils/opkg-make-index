#!/usr/bin/env python3
# -*- coding: utf-8 -*-
#
# opkg-make-index — generuje plik Packages dla repozytorium .ipk
# korzysta z opkg.py, pomija Size i Installed-Size
#

import sys
import os
from opkg import Package

def make_index(directory):
    index_entries = []
    for fname in sorted(os.listdir(directory)):
        if not fname.endswith(".ipk"):
            continue
        path = os.path.join(directory, fname)
        try:
            pkg = Package(path)
            entry = pkg.make_index_entry()
            index_entries.append(entry)
        except Exception as e:
            print(f"⚠️  Błąd przy przetwarzaniu {fname}: {e}", file=sys.stderr)
    return "\n".join(index_entries)

def main():
    if len(sys.argv) != 2:
        print(f"Użycie: {sys.argv[0]} <katalog_z_ipk>", file=sys.stderr)
        sys.exit(1)

    directory = sys.argv[1]
    if not os.path.isdir(directory):
        print(f"❌ {directory} nie jest katalogiem", file=sys.stderr)
        sys.exit(1)

    index_content = make_index(directory)
    sys.stdout.write(index_content)

if __name__ == "__main__":
    main()
